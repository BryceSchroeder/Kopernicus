// If any modder adds useKopernicusSolarPanels = false to a module instead of a part, add it to the part:
@PART:HAS[@MODULE:HAS[#useKopernicusSolarPanels[?alse]]]:FINAL
{
	%useKopernicusSolarPanels = false
}

// Uses regular expressions to convert any case variants like FalSe to false
@PART:HAS[#useKopernicusSolarPanels[*]]:FINAL
{
    // This cfg will enable KopernicusSolarPanels
    // to allow support for multiple lightsources
    // 
    // If you want to avoid this, add "useKopernicusSolarPanels = false" to the PART node
    // That will stop Kopernicus from changing the behaviour of SolarPanel
    @useKopernicusSolarPanels,* ^= :F:f:
    @useKopernicusSolarPanels,* ^= :A:a:
    @useKopernicusSolarPanels,* ^= :L:l:
    @useKopernicusSolarPanels,* ^= :S:s:
    @useKopernicusSolarPanels,* ^= :E:e:
}

//First delete all old "KopernicusSolarPanels" fixers
@PART:HAS[@MODULE[ModuleDeployableSolarPanel]]:FINAL
{
	!MODULE[KopernicusSolarPanels] {}
}

// clean up
@PART:HAS[#useKopernicusSolarPanels[*]]:FINAL
{
	!useKopernicusSolarPanels = delete
}

@PART:HAS[@MODULE:HAS[#useKopernicusSolarPanels[*]]]:FINAL
{
    @MODULE,*:HAS[#useKopernicusSolarPanels[*]]
	{
		!useKopernicusSolarPanels = delete
	}
}


//=======================================================================================================
// Solar panels support
//=======================================================================================================
@PART[*]:HAS[@MODULE[ModuleDeployableSolarPanel]]:NEEDS[!RealismOverhaul]:FOR[zKopernicus]
{
  // duplicate every ModuleDeployableSolarPanel
  // Some parts may use multiple MDSP modules,
  // so we have to add a KopernicusSolarPanel module each of them
  +MODULE[ModuleDeployableSolarPanel],*
  {
    // delete all values
    -* = delete
    // delete all possible nodes
    -powerCurve {}
    -temperatureEfficCurve {}
    -timeEfficCurve {}
    -UPGRADES {}
    // rename the module to KopernicusSolarPanel
    name = KopernicusSolarPanel
  }
}

@PART[*]:HAS[@MODULE[ModuleCurvedSolarPanel]]:NEEDS[!RealismOverhaul,NearFutureSolar]:FOR[zKopernicus]
{
	MODULE
	{
		name = KopernicusSolarPanel
	}
}

@PART[*]:HAS[@MODULE[SSTUSolarPanelStatic]]:NEEDS[!RealismOverhaul,SSTU]:FOR[zKopernicus]
{
	MODULE
	{
		name = KopernicusSolarPanel
	}
}

@PART[*]:HAS[@MODULE[SSTUSolarPanelDeployable]]:NEEDS[!RealismOverhaul,SSTU]:FOR[zKopernicus]
{
	MODULE
	{
		name = KopernicusSolarPanel
	}
}

// Only patch SSTUModularPart if it has a solar panel. 
// This isn't fail-proof as a modular part can have switcheable solar panels and "Solar-None" as the default option,
// but we want to avoid adding the SolarPanelFixer on parts that don't have a solar panel.
@PART[*]:HAS[@MODULE:HAS[#name[SSTUModularPart],!#currentSolar[Solar-None]]]:NEEDS[!RealismOverhaul,SSTU]:FOR[zKopernicus]
{
	MODULE
	{
		name = KopernicusSolarPanel
	}
}

//@PART:HAS[@MODULE[ModuleROSolar]]:FOR[zKopernicus]
//{ 
//  %MODULE[KopernicusSolarPanel]{} 
//}
